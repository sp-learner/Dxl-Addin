function openFormatSheetModal(){const e=document.getElementById("formatSheetModal"),t=document.getElementById("modalOverlay");e.style.display="block",t.style.display="block",initializeColumns(),loadFormatDropdown(),resetForm()}function closeModal2(){document.getElementById("formatSheet").style.display="none",document.getElementById("modalOverlay").style.display="none"}function displaySavedFormats(){const e=document.getElementById("savedFormatsContainer");e.innerHTML="",getAllSavedFormats().forEach((t=>{const o=document.createElement("button");o.className="format-btn",o.textContent=t.name,o.onclick=async function(){await loadFormatIntoWorkspace(t.name)},e.appendChild(o)}))}async function loadFormatIntoWorkspace(e){try{if(!Office.context.requirements.isSetSupported("ExcelApi","1.1"))throw new Error("Excel integration not supported");const t=JSON.parse(localStorage.getItem(`FORMAT_${e}`));if(!t)return void showToastNotification(`Format "${e}" not found!`);await Excel.run((async o=>{const n=o.workbook,a=o.workbook.worksheets.getActiveWorksheet();let l;try{l=n.worksheets.add(e)}catch(t){l=n.worksheets.getItem(e),l.activate(),l.getUsedRange().clear(Excel.ClearApplyTo.contents)}const r=a.getUsedRange();r.load("values, columnCount, rowCount"),await o.sync();const s=r.values,c=s[0],d=s.slice(1),m=t.columns,i={};m.forEach(((e,t)=>{const o=c.indexOf(e);if(-1!==o)return void(i[t]=o);const n=Object.keys(FormatSynonyms).find((t=>FormatSynonyms[t].includes(e)||t===e));if(n)for(let e=0;e<c.length;e++){const o=c[e];if(o===n||FormatSynonyms[n]?.includes(o)){i[t]=e;break}}})),m.map(((e,t)=>{const o=i[t];return void 0!==o?c[o]:m[t]})).forEach(((e,t)=>{l.getRange("1:1").getCell(0,t).values=[[e]]})),d.length>0&&d.forEach(((e,t)=>{Object.keys(i).forEach((o=>{const n=i[o];l.getRangeByIndexes(t+1,parseInt(o),1,1).values=[[e[n]]]}))})),l.getUsedRange().format.autofitColumns(),await o.sync(),showToastNotification(`"${e}" format applied Successfully`),localStorage.setItem("ACTIVE_FORMAT",e),closeModal2()}))}catch(t){console.error(`Error loading format "${e}":`,t),showToastNotification(`Failed: ${t.message}`)}}function showToastNotification(e,t="info"){const o=document.createElement("div");o.className=`toast-notification toast-${t}`,o.innerHTML=`\n    <div class="toast-icon"></div>\n    <div class="toast-message">${e}</div>\n  `,document.body.appendChild(o),setTimeout((()=>{o.classList.add("fade-out"),setTimeout((()=>o.remove()),300)}),3e3)}function getAllSavedFormats(){const e=[];for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);if(o.startsWith("FORMAT_"))try{const t=JSON.parse(localStorage.getItem(o));e.push(t)}catch(e){console.error("Error parsing format:",o,e)}}return e}function closeModal(e){"closeModal"!==e.target.id&&e.target!==document.getElementById("formatSheetModal")||(document.getElementById("formatSheetModal").style.display="none",document.getElementById("modalOverlay").style.display="none")}function initializeColumns(){const e=document.getElementById("availableColumns");0===e.options.length&&["Packet No","Status","Shape","Weight","Color","PinneyColor","Clarity","Rate","Disc","NetRate","Amount","Cut"].forEach(((t,o)=>{e.add(new Option(`${o+1}. ${t}`,t))}))}function loadFormatDropdown(){const e=document.getElementById("formatDropdown");e.innerHTML='<option value="">Select a format</option>',getAllSavedFormats().forEach((t=>{const o=document.createElement("option");o.value=t.name,o.textContent=t.name,e.appendChild(o)}))}function getAllSavedFormats(){const e=[];for(let t=0;t<localStorage.length;t++){const o=localStorage.key(t);if(o.startsWith("FORMAT_"))try{const t=JSON.parse(localStorage.getItem(o));e.push(t)}catch(e){console.error("Error parsing format:",o,e)}}return e}function loadSelectedFormat(){const e=document.getElementById("availableColumns");Array.from(e.options).forEach((e=>{e.classList.remove("transferred")}));const t=document.getElementById("formatDropdown").value;if(!t)return;const o=JSON.parse(localStorage.getItem(`FORMAT_${t}`));o&&(document.getElementById("formatName").value=o.name||"",resetSelectedColumns(),o.columns&&o.columns.length>0&&o.columns.forEach((t=>{const o=Array.from(e.options).find((e=>e.value===t));o&&o.classList.add("transferred"),addColumnToSelection(t)})))}function resetForm(){document.getElementById("formatName").value="",resetSelectedColumns(),document.getElementById("formatDropdown").value="";const e=document.getElementById("availableColumns");Array.from(e.options).forEach((e=>{e.classList.remove("transferred")}))}function resetSelectedColumns(){const e=document.getElementById("selectedColumnsContainer");e&&(e.innerHTML="")}function transferColumns(){const e=document.getElementById("availableColumns"),t=document.getElementById("selectedColumnsContainer");e&&t&&(Array.from(e.selectedOptions).forEach((e=>{Array.from(t.querySelectorAll("tr")).find((t=>t.dataset.column===e.value))||(addColumnToSelection(e.value,e.text),e.classList.add("transferred"),e.classList.add("selected-to-transfer"),setTimeout((()=>e.classList.remove("selected-to-transfer")),300))})),updateButtonStates())}function addColumnToTable(e,t){const o=document.getElementById("selectedColumnsContainer");if(!o)return;const n=document.createElement("tr");n.dataset.column=e;const a=document.createElement("td");a.textContent=o.querySelectorAll("tr").length+1;const l=document.createElement("td");l.textContent=t.split(". ")[1]||t,n.appendChild(a),n.appendChild(l),o.appendChild(n),updateSerialNumbers()}function updateSerialNumbers(){document.querySelectorAll("#selectedColumnsContainer tr").forEach(((e,t)=>{e.cells[0].textContent=t+1}))}function returnColumns(){const e=document.getElementById("availableColumns"),t=document.getElementById("selectedColumnsContainer");t&&(Array.from(t.querySelectorAll("tr.selected-row")).forEach((t=>{t.remove();const o=Array.from(e.options).find((e=>e.value===t.dataset.column));o&&(o.classList.remove("transferred"),o.classList.add("returned-option"),setTimeout((()=>o.classList.remove("returned-option")),300))})),updateSerialNumbers(),updateButtonStates())}function updateButtonStates(){const e=document.getElementById("availableColumns"),t=document.getElementById("selectedColumnsContainer");document.getElementById("addColumn").disabled=!e?.selectedOptions?.length,document.getElementById("removeColumn").disabled=!t?.querySelector("tr.selected-row")}function saveFormat(){try{const e=document.getElementById("formatName").value.trim(),t=document.getElementById("selectedColumnsContainer");if(!e)return void showToastNotification("Please enter a format name","error");const o=t?Array.from(t.querySelectorAll("tr")).map((e=>e.dataset.column)):[];if(0===o.length)return void showToastNotification("Please select at least one column","warning");const n={name:e,columns:o,timestamp:(new Date).toISOString()},a=null!==localStorage.getItem(`FORMAT_${e}`);localStorage.setItem(`FORMAT_${e}`,JSON.stringify(n)),loadFormatDropdown(),resetForm(),showToastNotification(a?`"${e}" updated successfully!`:`"${e}" created successfully!`,"success")}catch(e){console.error("Error saving format:",e),showToastNotification("Failed to save format","error")}}function deleteFormat(){try{const e=document.getElementById("formatDropdown");if(!e)return void showToastNotification("Format dropdown element not found","error");const t=e.value;if(!t)return void showToastNotification("Please select a format to delete","error");const o=`FORMAT_${t}`;if(!localStorage.getItem(o))return void showToastNotification(`Format "${t}" not found`,"error");localStorage.removeItem(o),loadFormatDropdown(),resetForm(),showToastNotification(`"${t}" deleted successfully`,"success")}catch(e){console.error("Delete format error:",e),showToastNotification("Failed to delete format","error")}}function addColumnToSelection(e){const t=document.getElementById("availableColumns"),o=document.getElementById("selectedColumnsContainer");if(t&&o)for(let n of t.options)if(n.value===e){Array.from(o.querySelectorAll("tr")).some((t=>t.dataset.column===e))||(addColumnToTable(n.value,n.text),n.classList.add("transferred"));break}}function initFormatSheet(){document.getElementById("closeModal")?.addEventListener("click",closeModal),document.getElementById("formatSheetModal")?.addEventListener("click",closeModal),document.getElementById("Format Sheet")?.addEventListener("click",closeModal2),document.getElementById("closeModal2")?.addEventListener("click",closeModal2),document.getElementById("addColumn")?.addEventListener("click",transferColumns),document.getElementById("removeColumn")?.addEventListener("click",returnColumns),document.getElementById("saveFormat")?.addEventListener("click",saveFormat),document.getElementById("deleteFormat")?.addEventListener("click",deleteFormat),document.getElementById("formatDropdown")?.addEventListener("change",loadSelectedFormat),document.getElementById("newFormatBtn")?.addEventListener("click",resetForm),document.getElementById("availableColumns")?.addEventListener("change",updateButtonStates),document.addEventListener("click",(function(e){document.getElementById("selectedColumnsContainer")&&e.target.closest("#selectedColumnsContainer tr")&&(e.target.closest("tr").classList.toggle("selected-row"),updateButtonStates())})),updateButtonStates()}document.getElementById("FormatSheet").addEventListener("click",(function(){document.getElementById("formatSheet").style.display="block",document.getElementById("modalOverlay").style.display="block",displaySavedFormats()})),document.getElementById("closeModal2").addEventListener("click",closeModal2),document.getElementById("modalOverlay").addEventListener("click",closeModal2),document.addEventListener("DOMContentLoaded",initFormatSheet);